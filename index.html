<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climbing Lab (Pro Version)</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --accent: #3498db;
            --active-speed: #e67e22;
            --success: #2ecc71;
            --warning: #f39c12;
            --toggle-on: #27ae60;
        }

        body {
            font-family: 'Sarabun', 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 { margin-bottom: 5px; font-weight: 300; text-transform: uppercase; letter-spacing: 1px; text-align: center; font-size: 1.5rem; }

        /* --- Volume Control --- */
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #333;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #444;
        }
        .volume-icon { font-size: 1.2rem; }
        input[type=range] {
            -webkit-appearance: none;
            width: 100px;
            height: 6px;
            background: #555;
            border-radius: 5px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        .volume-text { font-size: 0.8rem; color: #aaa; min-width: 35px; text-align: right; }

        /* --- Display Area --- */
        .display-area {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border: 2px solid #444;
            transition: border-color 0.2s;
        }

        .counter-badge {
            background: #444;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1.2rem;
            color: #ccc;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .counter-number { color: var(--accent); font-size: 1.6rem; }

        .status-msg { font-size: 0.9rem; padding: 2px 8px; border-radius: 4px; display: none; }
        .msg-move { background: var(--success); color: #000; display: inline-block;}
        .msg-stay { background: var(--warning); color: #000; display: inline-block;}

        .reset-counter-btn {
            position: absolute; top: 15px; right: 15px;
            background: transparent; border: 1px solid #555; color: #777;
            font-size: 0.8rem; padding: 4px 8px; border-radius: 5px; cursor: pointer;
        }
        .reset-counter-btn:hover { background: #e74c3c; color: white; border-color: #e74c3c; }

        .color-circle {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: #555; margin-bottom: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 4px solid #fff;
        }

        .result-text { font-size: 2.2rem; font-weight: bold; text-align: center; line-height: 1.2; }
        .result-subtext { font-size: 1.2rem; color: #aaa; margin-top: 5px; }

        /* --- Dashboard --- */
        .status-board {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            width: 100%; max-width: 400px; margin-bottom: 20px;
        }
        .limb-status {
            background: #333; padding: 10px; border-radius: 10px;
            display: flex; align-items: center; border: 1px solid #444;
        }
        .limb-label { font-weight: bold; min-width: 50px; margin-right: 5px; color: #aaa; font-size: 0.9rem; }
        .limb-color-dot { width: 15px; height: 15px; border-radius: 50%; background: #555; margin-right: 8px; border: 1px solid #fff; flex-shrink: 0; }
        .limb-color-name { font-size: 0.9rem; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Controls Container --- */
        .controls-container {
            width: 100%; max-width: 400px;
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;
        }

        .spin-btn {
            background-color: var(--accent); color: white; border: none;
            padding: 15px 0; font-size: 1.5rem; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: transform 0.1s; width: 100%; font-weight: bold;
        }
        .spin-btn:active { transform: scale(0.95); }
        .spin-btn:disabled { background-color: #555; cursor: not-allowed; }

        /* --- Toggle Switch (No Repeat) --- */
        .toggle-row {
            display: flex; justify-content: space-between; align-items: center;
            background: #333; padding: 10px 15px; border-radius: 10px;
            border: 1px solid #444;
        }
        .toggle-label { font-size: 1rem; color: #fff; display: flex; align-items: center; gap: 8px;}
        .toggle-desc { font-size: 0.75rem; color: #aaa; }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #555; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 20px; width: 20px;
            left: 3px; bottom: 3px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--toggle-on); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- Speed Controls --- */
        .speed-control-container {
            display: flex; gap: 5px; flex-wrap: wrap;
            justify-content: center; background: #333;
            padding: 5px; border-radius: 30px;
        }
        .speed-btn {
            flex-grow: 1;
            background: transparent; border: none; color: #aaa; padding: 8px 10px;
            border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            white-space: nowrap;
        }
        .speed-btn.active { background-color: var(--active-speed); color: white; }
        .speed-btn.instant { color: #ff5e57; font-weight: bold; }
        .speed-btn.instant.active { background-color: #ff5e57; color: white; }

        /* --- History & Settings --- */
        .history-container, .settings-area {
            width: 100%; max-width: 400px; background: #222;
            border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #444;
        }
        .history-title { margin: 0 0 10px 0; font-size: 1rem; color: #aaa; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .history-list {
            list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto;
            display: flex; flex-direction: column-reverse;
        }
        .history-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #333; font-size: 0.9rem; }
        .hist-move { color: var(--accent); font-weight: bold; margin-right: 10px; min-width: 25px;}
        .hist-detail { flex-grow: 1; }
        .hist-status { font-size: 0.8rem; opacity: 0.7; }

        /* Color Settings */
        .color-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; }
        .color-item { display: flex; align-items: center; background: #333; margin-bottom: 5px; padding: 8px 10px; border-radius: 8px; }
        .color-preview { width: 20px; height: 20px; border-radius: 50%; margin-right: 10px; border: 1px solid #fff; }
        .color-name { flex-grow: 1; font-size: 0.9rem; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .add-color-form { display: flex; gap: 5px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #444; }
        input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #555; background: #222; color: white; }
        input[type="color"] { width: 40px; height: 35px; border: none; background: none; cursor: pointer; }
        .add-btn { background: #27ae60; color: white; border: none; padding: 0 15px; border-radius: 5px; cursor: pointer; }

    </style>
</head>
<body>

    <h1>‡∏õ‡∏µ‡∏ô‡∏ú‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡∏ß‡∏á</h1>

    <div class="volume-container">
        <span class="volume-icon">üîä</span>
        <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.5" oninput="updateVolume(this.value)">
        <span class="volume-text" id="volumeText">50%</span>
    </div>

    <div class="display-area" id="displayBox">
        <button class="reset-counter-btn" onclick="resetGame()" title="‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>

        <div class="counter-badge">
            ‡πÅ‡∏ï‡πâ‡∏°: <span id="moveCountDisplay" class="counter-number">0</span>
            <span id="moveStatusBadge" class="status-msg msg-move">‡∏Ç‡∏¢‡∏±‡∏ö</span>
        </div>

        <div class="color-circle" id="resultCircle"></div>
        <div class="result-text" id="resultText">‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
        <div class="result-subtext" id="resultColorName">-</div>
    </div>

    <div class="status-board" id="statusBoardContainer"></div>

    <div class="controls-container">

        <button class="spin-btn" id="spinBtn" onclick="spinWheel()">‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏¢! (SPIN)</button>

        <div class="toggle-row">
            <div>
                <div class="toggle-label">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏¢‡∏±‡∏ö (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)</div>
                <div class="toggle-desc">‡∏ñ‡πâ‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° ‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            </div>
            <label class="switch">
                <input type="checkbox" id="noRepeatToggle" onchange="toggleNoRepeat()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="speed-control-container">
            <button class="speed-btn" onclick="setSpeed(0.5, this)">x0.5</button>
            <button class="speed-btn active" onclick="setSpeed(1, this)">x1</button>
            <button class="speed-btn" onclick="setSpeed(2, this)">x2</button>
            <button class="speed-btn" onclick="setSpeed(4, this)">x4</button>
            <button class="speed-btn" onclick="setSpeed(8, this)">x8</button>
            <button class="speed-btn instant" onclick="setSpeed(88, this)">x88 (‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</button>
        </div>
    </div>

    <div class="history-container">
        <h4 class="history-title">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏µ‡∏ô (History)</h4>
        <ul class="history-list" id="historyList"></ul>
    </div>

    <div class="settings-area">
        <div style="border-bottom: 1px solid #444; margin-bottom: 10px; padding-bottom: 5px; color:#aaa;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ (Color Setup)</div>
        <ul class="color-list" id="colorList"></ul>
        <div class="add-color-form">
            <input type="text" id="newColorName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ">
            <input type="color" id="newColorHex" value="#3498db">
            <button class="add-btn" onclick="addColor()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
    </div>

    <script>
        // --- Data ---
        const limbs = ['‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢', '‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤', '‡∏Ç‡∏≤‡∏ã‡πâ‡∏≤‡∏¢', '‡∏Ç‡∏≤‡∏Ç‡∏ß‡∏≤'];
        let colors = [
            { name: '‡∏°‡πà‡∏ß‡∏á', hex: '#9b59b6' },
            { name: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', hex: '#f1c40f' },
            { name: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', hex: '#2ecc71' },
            { name: '‡πÅ‡∏î‡∏á', hex: '#e74c3c' }
        ];

        // --- State ---
        let speedMultiplier = 1;
        let isInstantMode = false;
        let isNoRepeatMode = false; // ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏¢‡∏±‡∏ö
        let moveCount = 0;
        let isSpinning = false;
        let currentPositions = {};

        // Init positions
        limbs.forEach(limb => currentPositions[limb] = null);

        // --- Initialization ---
        function initDashboard() {
            const container = document.getElementById('statusBoardContainer');
            container.innerHTML = '';
            limbs.forEach(limb => {
                const div = document.createElement('div');
                div.className = 'limb-status';
                div.innerHTML = `
                    <div class="limb-label">${limb}</div>
                    <div class="limb-color-dot" id="dot-${limb}"></div>
                    <div class="limb-color-name" id="name-${limb}">-</div>
                `;
                container.appendChild(div);
            });
        }
        initDashboard();

        // --- Audio & Volume Control ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // ** ‡∏™‡∏£‡πâ‡∏≤‡∏á Master Gain Node (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏•‡∏±‡∏Å) **
        const masterGainNode = audioCtx.createGain();
        masterGainNode.connect(audioCtx.destination);
        masterGainNode.gain.value = 0.5; // Default 50%

        function updateVolume(val) {
            // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç %
            masterGainNode.gain.value = val;
            document.getElementById('volumeText').innerText = Math.round(val * 100) + "%";

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const icon = document.querySelector('.volume-icon');
            if (val == 0) icon.innerText = 'üîá';
            else icon.innerText = 'üîä';
        }

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const noteGain = audioCtx.createGain(); // Gain ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á

            osc.connect(noteGain);
            // ** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Master Gain ‡πÅ‡∏ó‡∏ô Destination **
            noteGain.connect(masterGainNode);

            if (type === 'tick') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.05);
                noteGain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                noteGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            } else if (type === 'win') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                noteGain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                noteGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'stay') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                noteGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                noteGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start(); osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- Core Logic ---

        function setSpeed(val, btnElement) {
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            if (val === 88) {
                isInstantMode = true;
                speedMultiplier = 1; // ‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏≠‡∏Å‡πÜ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏•‡∏π‡∏õ
            } else {
                isInstantMode = false;
                speedMultiplier = val;
            }
        }

        function toggleNoRepeat() {
            const checkbox = document.getElementById('noRepeatToggle');
            isNoRepeatMode = checkbox.checked;
        }

        function resetGame() {
            moveCount = 0;
            limbs.forEach(limb => currentPositions[limb] = null);
            document.getElementById('moveCountDisplay').innerText = moveCount;
            document.getElementById('historyList').innerHTML = '';
            document.getElementById('moveStatusBadge').style.display = 'none';
            document.getElementById('resultText').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°";
            document.getElementById('resultColorName').innerText = "-";
            document.getElementById('resultCircle').style.backgroundColor = "#555";
            updateStatusBoard();
        }

        function spinWheel() {
            if (isSpinning) return;
            if (colors.length === 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('moveStatusBadge').style.display = 'none';

            // --- Logic ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ (Final Result Calculation) ---
            let finalLimb, finalColor;
            let retryCount = 0;
            const maxRetries = 100; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Loop ‡∏ô‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

            do {
                finalLimb = limbs[Math.floor(Math.random() * limbs.length)];
                finalColor = colors[Math.floor(Math.random() * colors.length)];
                retryCount++;

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥ -> Loop ‡∏ï‡πà‡∏≠‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏á‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ Loop ‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏£‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏°‡∏´‡∏•‡∏∏‡∏î‡∏•‡∏π‡∏õ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏•‡∏¢
            } while (isNoRepeatMode && currentPositions[finalLimb] === finalColor.name && retryCount < maxRetries);

            // --------------------------------------------------------

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (x88)
            if (isInstantMode) {
                updateDisplay(finalLimb, finalColor);
                finishSpin(finalLimb, finalColor);
                return;
            }

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏°‡∏µ Animation)
            let count = 0;
            let baseStartDelay = 40;
            let stepIncrease = 10;
            let totalSteps = 15;

            const run = () => {
                // ‡∏™‡∏∏‡πà‡∏°‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏•‡∏≠‡∏Å‡πÜ ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏ô
                let tempLimb = limbs[Math.floor(Math.random() * limbs.length)];
                let tempColor = colors[Math.floor(Math.random() * colors.length)];

                // ‡∏£‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô
                if (count === totalSteps - 1) {
                    tempLimb = finalLimb;
                    tempColor = finalColor;
                }

                updateDisplay(tempLimb, tempColor);
                playSound('tick');

                count++;

                if (count < totalSteps) {
                    let currentBaseDelay = baseStartDelay + (count * stepIncrease);
                    let actualDelay = currentBaseDelay / speedMultiplier;
                    setTimeout(run, actualDelay);
                } else {
                    finishSpin(finalLimb, finalColor);
                }
            };
            run();
        }

        function finishSpin(limb, colorObj) {
            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;

            const previousColorName = currentPositions[limb];
            const isSamePosition = previousColorName === colorObj.name;

            const badge = document.getElementById('moveStatusBadge');
            badge.style.display = 'inline-block';

            if (isSamePosition) {
                // ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î NoRepeat ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                playSound('stay');
                badge.className = 'status-msg msg-stay';
                badge.innerText = "‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°";
                addToHistory('-', limb, colorObj.name, true);
            } else {
                // ‡∏Ç‡∏¢‡∏±‡∏ö
                playSound('win');
                moveCount++;
                document.getElementById('moveCountDisplay').innerText = moveCount;
                badge.className = 'status-msg msg-move';
                badge.innerText = "‡∏Ç‡∏¢‡∏±‡∏ö +1";
                currentPositions[limb] = colorObj.name;
                addToHistory(moveCount, limb, colorObj.name, false);

                const displayBox = document.getElementById('displayBox');
                displayBox.style.borderColor = colorObj.hex;
                setTimeout(() => displayBox.style.borderColor = '#444', 500);
            }

            updateStatusBoard();
        }

        function updateDisplay(limb, colorObj) {
            document.getElementById('resultText').innerText = limb;
            document.getElementById('resultColorName').innerText = colorObj.name;
            document.getElementById('resultCircle').style.backgroundColor = colorObj.hex;
        }

        function updateStatusBoard() {
            limbs.forEach(limb => {
                const colorName = currentPositions[limb];
                const dot = document.getElementById(`dot-${limb}`);
                const txt = document.getElementById(`name-${limb}`);

                if (colorName) {
                    const cObj = colors.find(c => c.name === colorName);
                    dot.style.backgroundColor = cObj ? cObj.hex : '#555';
                    txt.innerText = colorName;
                    txt.style.color = '#fff';
                } else {
                    dot.style.backgroundColor = '#555';
                    txt.innerText = '-';
                    txt.style.color = '#777';
                }
            });
        }

        function addToHistory(idx, limb, colorName, isStay) {
            const list = document.getElementById('historyList');
            const li = document.createElement('li');
            li.className = 'history-item';
            let statusText = isStay ? '<span class="hist-status" style="color:#f39c12">(‡∏ã‡πâ‡∏≥)</span>' : '';
            let indexText = isStay ? '--' : `#${idx}`;
            li.innerHTML = `
                <span class="hist-move">${indexText}</span>
                <span class="hist-detail">${limb} &rarr; ${colorName} ${statusText}</span>
            `;
            list.prepend(li);
        }

        // --- Color Helper ---
        function renderColors() {
            const list = document.getElementById('colorList');
            list.innerHTML = '';
            colors.forEach((c, index) => {
                const li = document.createElement('li');
                li.className = 'color-item';
                li.innerHTML = `
                    <div class="color-preview" style="background-color: ${c.hex};"></div>
                    <span class="color-name">${c.name}</span>
                    <button class="delete-btn" onclick="removeColor(${index})">‡∏•‡∏ö</button>
                `;
                list.appendChild(li);
            });
        }

        function addColor() {
            const name = document.getElementById('newColorName').value.trim();
            const hex = document.getElementById('newColorHex').value;
            if (!name) return;
            colors.push({ name, hex });
            document.getElementById('newColorName').value = '';
            renderColors();
        }

        function removeColor(index) {
            colors.splice(index, 1);
            renderColors();
        }

        renderColors();
    </script>
</body>
</html>
